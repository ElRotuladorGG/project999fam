<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Financiero Familiar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ========================================================
        // 1. CONFIGURACI√ìN DE TU BASE DE DATOS (PASO OBLIGATORIO)
        // ========================================================
        // Ve a console.firebase.google.com -> Configuraci√≥n del proyecto -> Tus apps
        // Copia el objeto 'firebaseConfig' y p√©galo aqu√≠ abajo:

        let firebaseConfig = null;

        // Intentar detectar si estamos en el entorno de desarrollo o producci√≥n
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.log("No se detect√≥ configuraci√≥n autom√°tica, usando configuraci√≥n manual.");
        }

        /* ‚ö†Ô∏è CUANDO EST√âS EN GITHUB, BORRA LAS SIGUIENTES L√çNEAS Y PEGA TU CONFIGURACI√ìN AS√ç:
           
           firebaseConfig = {
             apiKey: "AIzaSy...",
             authDomain: "tu-proyecto.firebaseapp.com",
             projectId: "tu-proyecto",
             storageBucket: "tu-proyecto.appspot.com",
             messagingSenderId: "123456789",
             appId: "1:123456789:web:abcdef"
           };
        */

        const appId = "mi-familia-finanzas"; // Puedes dejar esto as√≠

        // --- VERIFICACI√ìN DE SEGURIDAD ---
        if (!firebaseConfig) {
            window.addEventListener('DOMContentLoaded', () => {
                document.getElementById('setup-error').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
            });
        } else {
            initApp();
        }

        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                let transactions = [];
                let currentType = 'income';
                let chart = null;
                let familyPin = null;
                let isAuthorized = false;

                // Auth
                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
                        try {
                            const configSnap = await getDoc(configRef);
                            if (!configSnap.exists()) {
                                showScreen('setup-screen');
                            } else {
                                familyPin = configSnap.data().accessPin;
                                if (localStorage.getItem('family_access_token') === familyPin) {
                                    authorize(db, appId);
                                } else {
                                    showScreen('login-screen');
                                }
                            }
                        } catch (err) {
                            console.error("Error de permisos:", err);
                            document.getElementById('db-error').classList.remove('hidden');
                            document.getElementById('loading-screen').classList.add('hidden');
                        }
                    }
                });

                // Funciones globales vinculadas a los botones
                window.setupFamilyPin = async () => {
                    const pin1 = document.getElementById('new-pin').value;
                    const pin2 = document.getElementById('confirm-pin').value;
                    if (pin1.length < 4 || pin1 !== pin2) return alert("PIN inv√°lido o no coinciden");
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), { accessPin: pin1 });
                    familyPin = pin1;
                    authorize(db, appId);
                };

                window.loginWithPin = () => {
                    if (document.getElementById('login-pin').value === familyPin) {
                        localStorage.setItem('family_access_token', familyPin);
                        authorize(db, appId);
                    } else alert("PIN Incorrecto");
                };

                function authorize(db, appId) {
                    isAuthorized = true;
                    showScreen('main-app');
                    const transactionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                    onSnapshot(transactionsRef, (snap) => {
                        transactions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        transactions.sort((a,b) => new Date(b.date) - new Date(a.date));
                        updateUI(transactions);
                    });
                }

                window.addTransaction = async (e) => {
                    e.preventDefault();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                        member: document.getElementById('member').value,
                        amount: parseFloat(document.getElementById('amount').value),
                        type: currentType,
                        category: document.getElementById('category').value,
                        date: document.getElementById('date').value,
                        createdAt: new Date().toISOString()
                    });
                    e.target.reset();
                    document.getElementById('date').valueAsDate = new Date();
                };

                window.removeTransaction = async (id) => {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id));
                };

            } catch (error) {
                console.error("Fallo cr√≠tico:", error);
            }
        }

        // --- UTILS UI ---
        function showScreen(id) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function updateUI(data) {
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            let tin = 0, tout = 0;
            data.forEach(t => {
                if(t.type === 'income') tin += t.amount; else tout += t.amount;
                list.innerHTML += `<tr class="border-b text-sm">
                    <td class="p-3">${t.date}</td>
                    <td class="p-3 font-bold">${t.member}</td>
                    <td class="p-3 text-slate-500">${t.category}</td>
                    <td class="p-3 text-right font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-rose-600'}">${t.type === 'income' ? '+' : '-'} $${t.amount.toFixed(2)}</td>
                    <td class="p-3 text-center"><button onclick="removeTransaction('${t.id}')" class="text-rose-400">‚úï</button></td>
                </tr>`;
            });
            document.getElementById('total-balance').innerText = `$${(tin - tout).toFixed(2)}`;
            document.getElementById('total-income').innerText = `$${tin.toFixed(2)}`;
            document.getElementById('total-expense').innerText = `$${tout.toFixed(2)}`;
            document.getElementById('record-count').innerText = `${data.length} registros`;
            updateChart(tin, tout);
        }

        function updateChart(tin, tout) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Ingresos', 'Egresos'], datasets: [{ data: [tin, tout], backgroundColor: ['#10b981', '#f43f5e'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        window.setType = (type) => {
            currentType = type;
            document.getElementById('btn-income').className = `p-2 rounded border ${type === 'income' ? 'bg-emerald-500 text-white font-bold' : 'bg-slate-50'}`;
            document.getElementById('btn-expense').className = `p-2 rounded border ${type === 'expense' ? 'bg-rose-500 text-white font-bold' : 'bg-slate-50'}`;
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- ERROR: CONFIGURACI√ìN FALTANTE -->
    <div id="setup-error" class="hidden flex flex-col items-center justify-center min-h-screen p-6 text-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl border-t-4 border-orange-500 max-w-md">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">‚ö†Ô∏è Falta Configuraci√≥n</h2>
            <p class="text-slate-600 mb-6">Para que esto funcione en GitHub, necesitas crear un proyecto en <b>Firebase</b> y pegar tus credenciales en el c√≥digo del archivo <code>index.html</code>.</p>
            <ol class="text-left text-sm text-slate-500 space-y-2 mb-6">
                <li>1. Ve a console.firebase.google.com</li>
                <li>2. Crea un proyecto y a√±ade una "Web App"</li>
                <li>3. Copia el objeto <code>firebaseConfig</code></li>
                <li>4. Reemplaza el bloque en el c√≥digo</li>
            </ol>
        </div>
    </div>

    <!-- ERROR: PERMISOS DE BASE DE DATOS -->
    <div id="db-error" class="hidden flex flex-col items-center justify-center min-h-screen p-6 text-center">
        <div class="bg-white p-8 rounded-2xl shadow-xl border-t-4 border-rose-500 max-w-md">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üö´ Error de Permisos</h2>
            <p class="text-slate-600">Tu base de datos Firestore est√° bloqueada. Debes ir a la pesta√±a <b>"Rules"</b> en Firebase y permitir lecturas/escrituras.</p>
        </div>
    </div>

    <!-- PANTALLA CARGA -->
    <div id="loading-screen" class="flex items-center justify-center min-h-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <!-- PANTALLA: SETUP PIN -->
    <div id="setup-screen" class="screen hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Seguridad Familiar</h2>
            <p class="text-sm text-slate-500 mb-6">Define el PIN para que solo tu familia pueda entrar.</p>
            <input type="password" id="new-pin" placeholder="PIN (4+ d√≠gitos)" class="w-full p-3 border rounded-lg mb-4 text-center text-xl">
            <input type="password" id="confirm-pin" placeholder="Confirmar PIN" class="w-full p-3 border rounded-lg mb-6 text-center text-xl">
            <button onclick="setupFamilyPin()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">Crear PIN</button>
        </div>
    </div>

    <!-- PANTALLA: LOGIN -->
    <div id="login-screen" class="screen hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-6">Acceso Protegido</h2>
            <input type="password" id="login-pin" placeholder="PIN de acceso" class="w-full p-3 border rounded-lg mb-6 text-center text-2xl tracking-widest">
            <button onclick="loginWithPin()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">Entrar</button>
        </div>
    </div>

    <!-- PANTALLA: APP -->
    <div id="main-app" class="screen hidden p-4 md:p-8 max-w-6xl mx-auto">
        <div class="flex justify-between items-end mb-8">
            <h1 class="text-2xl font-bold">Control de Gastos Familiares</h1>
            <button onclick="localStorage.clear(); location.reload()" class="text-xs text-slate-400 underline">Cerrar Sesi√≥n</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-4 rounded-xl shadow-sm border">
                <p class="text-xs text-slate-400 uppercase font-bold">Balance</p>
                <h2 id="total-balance" class="text-2xl font-bold text-slate-800">$0.00</h2>
            </div>
            <div class="bg-emerald-50 p-4 rounded-xl shadow-sm border border-emerald-100 text-emerald-700">
                <p class="text-xs uppercase font-bold">Ingresos</p>
                <h2 id="total-income" class="text-2xl font-bold">$0.00</h2>
            </div>
            <div class="bg-rose-50 p-4 rounded-xl shadow-sm border border-rose-100 text-rose-700">
                <p class="text-xs uppercase font-bold">Egresos</p>
                <h2 id="total-expense" class="text-2xl font-bold">$0.00</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="space-y-6">
                <form onsubmit="addTransaction(event)" id="transaction-form" class="bg-white p-6 rounded-xl shadow-md space-y-4">
                    <select id="member" class="w-full p-2 border rounded" required>
                        <option value="Yo">Yo</option><option value="Pap√°">Pap√°</option><option value="Mam√°">Mam√°</option><option value="Hermano/a">Hermano/a</option>
                    </select>
                    <input type="number" id="amount" step="0.01" placeholder="Monto $" class="w-full p-2 border rounded" required>
                    <div class="grid grid-cols-2 gap-2">
                        <button type="button" onclick="setType('income')" id="btn-income" class="p-2 rounded border bg-emerald-500 text-white font-bold">Ingreso</button>
                        <button type="button" onclick="setType('expense')" id="btn-expense" class="p-2 rounded border bg-slate-50">Egreso</button>
                    </div>
                    <input type="text" id="category" placeholder="Categor√≠a" class="w-full p-2 border rounded" required>
                    <input type="date" id="date" class="w-full p-2 border rounded" required>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">Guardar</button>
                </form>
                <div class="bg-white p-4 rounded-xl shadow-md h-48"><canvas id="categoryChart"></canvas></div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-4 border-b flex justify-between bg-slate-50"><span class="font-bold">Historial</span><span id="record-count" class="text-xs">...</span></div>
                    <div class="max-h-96 overflow-y-auto">
                        <table class="w-full text-left">
                            <tbody id="transaction-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
