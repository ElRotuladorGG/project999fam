<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Financiero Familiar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ========================================================
        // 1. CONFIGURACI√ìN DE TU BASE DE DATOS (PASO OBLIGATORIO)
        // ========================================================
        // Ve a console.firebase.google.com -> Configuraci√≥n del proyecto -> Tus apps
        // Copia el objeto 'firebaseConfig' y p√©galo aqu√≠ abajo:

        let firebaseConfig = null;

        // Intentar detectar configuraci√≥n autom√°tica del entorno de simulaci√≥n
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.log("Modo manual activo.");
        }

        /* ‚ö†Ô∏è INSTRUCCIONES PARA GITHUB PAGES:
           Borra "let firebaseConfig = null;" y pega tus credenciales reales aqu√≠:

           const firebaseConfig = {
             apiKey: "TU_API_KEY",
             authDomain: "tu-proyecto.firebaseapp.com",
             projectId: "tu-proyecto",
             storageBucket: "tu-proyecto.appspot.com",
             messagingSenderId: "123456789",
             appId: "1:123456789:web:abcdef"
           };
        */

        const appId = "mi-familia-finanzas"; 

        function showScreen(id) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('setup-error').classList.add('hidden');
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(id);
            if (target) target.classList.remove('hidden');
        }

        // --- INICIO DE LA APP ---
        if (!firebaseConfig) {
            // Si no hay configuraci√≥n, mostramos instrucciones tras un breve delay
            setTimeout(() => showScreen('setup-error'), 800);
        } else {
            initApp();
        }

        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);

                let transactions = [];
                let currentType = 'income';
                let familyPin = null;

                // Login an√≥nimo inicial
                await signInAnonymously(auth);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const configRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings');
                        try {
                            const configSnap = await getDoc(configRef);
                            if (!configSnap.exists()) {
                                // Es la primera vez que se usa la app: crear PIN
                                showScreen('setup-screen');
                            } else {
                                familyPin = configSnap.data().accessPin;
                                // Verificar si el PIN est√° guardado en este navegador
                                if (localStorage.getItem('family_access_token') === familyPin) {
                                    authorize(db, appId);
                                } else {
                                    showScreen('login-screen');
                                }
                            }
                        } catch (err) {
                            console.error("Error de Firestore:", err);
                            showScreen('db-error');
                        }
                    }
                });

                // Funciones globales para botones
                window.setupFamilyPin = async () => {
                    const pin1 = document.getElementById('new-pin').value;
                    const pin2 = document.getElementById('confirm-pin').value;
                    if (pin1.length < 4 || pin1 !== pin2) return alert("El PIN debe ser igual en ambos campos y tener al menos 4 n√∫meros.");
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'settings'), { accessPin: pin1 });
                    familyPin = pin1;
                    authorize(db, appId);
                };

                window.loginWithPin = () => {
                    if (document.getElementById('login-pin').value === familyPin) {
                        localStorage.setItem('family_access_token', familyPin);
                        authorize(db, appId);
                    } else alert("PIN Incorrecto");
                };

                window.addTransaction = async (e) => {
                    e.preventDefault();
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'transactions'), {
                            member: document.getElementById('member').value,
                            amount: parseFloat(document.getElementById('amount').value),
                            type: window.currentType,
                            category: document.getElementById('category').value,
                            date: document.getElementById('date').value,
                            createdAt: new Date().toISOString()
                        });
                        e.target.reset();
                        document.getElementById('date').valueAsDate = new Date();
                        window.setType('income');
                    } catch (err) {
                        alert("Error al guardar. Revisa las reglas de tu base de datos.");
                    }
                };

                window.removeTransaction = async (id) => {
                    if(confirm("¬øSeguro que quieres eliminar este registro?")) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'transactions', id));
                    }
                };

                function authorize(db, appId) {
                    showScreen('main-app');
                    const transactionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                    onSnapshot(transactionsRef, (snap) => {
                        transactions = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        transactions.sort((a,b) => new Date(b.date) - new Date(a.date));
                        updateUI(transactions);
                    });
                }
            } catch (error) {
                console.error("Fallo inicializaci√≥n:", error);
                showScreen('setup-error');
            }
        }

        function updateUI(data) {
            const list = document.getElementById('transaction-list');
            list.innerHTML = '';
            let tin = 0, tout = 0;
            data.forEach(t => {
                if(t.type === 'income') tin += t.amount; else tout += t.amount;
                list.innerHTML += `<tr class="border-b text-sm hover:bg-slate-50 transition">
                    <td class="p-3 text-slate-500">${t.date}</td>
                    <td class="p-3 font-bold text-slate-700">${t.member}</td>
                    <td class="p-3 text-slate-600">${t.category}</td>
                    <td class="p-3 text-right font-bold ${t.type === 'income' ? 'text-emerald-600' : 'text-rose-600'}">${t.type === 'income' ? '+' : '-'} $${t.amount.toFixed(2)}</td>
                    <td class="p-3 text-center"><button onclick="removeTransaction('${t.id}')" class="text-rose-300 hover:text-rose-600">‚úï</button></td>
                </tr>`;
            });
            document.getElementById('total-balance').innerText = `$${(tin - tout).toFixed(2)}`;
            document.getElementById('total-income').innerText = `$${tin.toFixed(2)}`;
            document.getElementById('total-expense').innerText = `$${tout.toFixed(2)}`;
            document.getElementById('record-count').innerText = `${data.length} registros`;
            updateChart(tin, tout);
        }

        function updateChart(tin, tout) {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Ingresos', 'Egresos'], datasets: [{ data: [tin, tout], backgroundColor: ['#10b981', '#f43f5e'], borderWeight: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }

        window.setType = (type) => {
            window.currentType = type;
            document.getElementById('btn-income').className = `p-2 rounded-lg border transition text-sm ${type === 'income' ? 'bg-emerald-500 text-white font-bold border-emerald-500 shadow-md' : 'bg-white text-slate-400 border-slate-200'}`;
            document.getElementById('btn-expense').className = `p-2 rounded-lg border transition text-sm ${type === 'expense' ? 'bg-rose-500 text-white font-bold border-rose-500 shadow-md' : 'bg-white text-slate-400 border-slate-200'}`;
        };
        window.currentType = 'income'; 
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .screen { transition: opacity 0.3s ease; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <!-- PANTALLA CARGA -->
    <div id="loading-screen" class="flex flex-col items-center justify-center min-h-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-slate-400 text-sm">Verificando conexi√≥n segura...</p>
    </div>

    <!-- ERROR: CONFIGURACI√ìN FALTANTE -->
    <div id="setup-error" class="hidden flex flex-col items-center justify-center min-h-screen p-6 text-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl border-t-8 border-blue-500 max-w-md">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">¬°Casi listo! üöÄ</h2>
            <p class="text-slate-600 mb-6">Tu p√°gina est√° en l√≠nea, pero a√∫n no tiene una base de datos propia conectada.</p>
            <div class="text-left bg-blue-50 p-5 rounded-2xl text-xs text-blue-800 space-y-3 mb-6 font-medium">
                <p>1Ô∏è‚É£ Ve a <a href="https://console.firebase.google.com" target="_blank" class="underline font-bold">Firebase Console</a>.</p>
                <p>2Ô∏è‚É£ Crea un proyecto y a√±ade una <b>Web App</b>.</p>
                <p>3Ô∏è‚É£ Copia el c√≥digo de <b>firebaseConfig</b>.</p>
                <p>4Ô∏è‚É£ Edita este archivo en GitHub y pega tus llaves donde corresponde.</p>
            </div>
            <p class="text-[10px] text-slate-400 italic italic">Cuando pegues tus llaves, esta p√°gina se convertir√° autom√°ticamente en tu gestor financiero familiar.</p>
        </div>
    </div>

    <!-- ERROR: REGLAS FIRESTORE -->
    <div id="db-error" class="hidden flex flex-col items-center justify-center min-h-screen p-6 text-center">
        <div class="bg-white p-8 rounded-3xl shadow-2xl border-t-8 border-rose-500 max-w-md">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">üö´ Error de Acceso</h2>
            <p class="text-slate-600 mb-4">La base de datos est√° bloqueada por Google.</p>
            <p class="text-sm text-slate-500 leading-relaxed">Debes ir a Firebase -> Firestore Database -> pesta√±a <b>Rules</b> y cambiar las reglas para permitir lectura/escritura.</p>
        </div>
    </div>

    <!-- PANTALLA: CONFIGURACI√ìN PIN -->
    <div id="setup-screen" class="screen hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-100">
            <h2 class="text-2xl font-bold mb-2">Seguridad Familiar</h2>
            <p class="text-sm text-slate-500 mb-8">Protege tus datos financieros con un PIN de acceso.</p>
            <div class="space-y-4">
                <input type="password" id="new-pin" placeholder="PIN de 4 n√∫meros" class="w-full p-4 border border-slate-200 rounded-2xl text-center text-2xl tracking-widest focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="password" id="confirm-pin" placeholder="Repite el PIN" class="w-full p-4 border border-slate-200 rounded-2xl text-center text-2xl tracking-widest focus:ring-2 focus:ring-blue-500 outline-none">
                <button onclick="setupFamilyPin()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200">Crear Acceso Seguro</button>
            </div>
        </div>
    </div>

    <!-- PANTALLA: LOGIN -->
    <div id="login-screen" class="screen hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white p-10 rounded-3xl shadow-2xl w-full max-w-sm text-center border border-slate-100">
            <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            </div>
            <h2 class="text-2xl font-bold mb-8 text-slate-800">Introducir PIN</h2>
            <input type="password" id="login-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-4 border border-slate-200 rounded-2xl text-center text-3xl tracking-[0.5em] mb-8 focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="loginWithPin()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold hover:bg-black transition shadow-xl">Entrar al Gestor</button>
        </div>
    </div>

    <!-- PANTALLA: APLICACI√ìN PRINCIPAL -->
    <div id="main-app" class="screen hidden p-4 md:p-8 max-w-6xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-slate-800 tracking-tight">Finanzas Familiares</h1>
                <p class="text-xs text-slate-400 font-semibold uppercase tracking-wider">Sincronizaci√≥n en tiempo real</p>
            </div>
            <div class="flex gap-4 items-center">
                <button onclick="localStorage.clear(); location.reload()" class="text-xs font-bold text-slate-400 hover:text-rose-500 transition uppercase">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <!-- Tarjetas de Resumen -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Balance Disponible</p>
                <h2 id="total-balance" class="text-3xl font-bold text-slate-800">$0.00</h2>
            </div>
            <div class="bg-emerald-50 p-6 rounded-3xl border border-emerald-100 text-emerald-700">
                <p class="text-[10px] uppercase font-bold mb-2">Total Ingresos</p>
                <h2 id="total-income" class="text-3xl font-bold">$0.00</h2>
            </div>
            <div class="bg-rose-50 p-6 rounded-3xl border border-rose-100 text-rose-700">
                <p class="text-[10px] uppercase font-bold mb-2">Total Egresos</p>
                <h2 id="total-expense" class="text-3xl font-bold">$0.00</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <!-- Columna Izquierda: Formulario -->
            <div class="space-y-8">
                <form onsubmit="addTransaction(event)" id="transaction-form" class="bg-white p-8 rounded-3xl shadow-xl space-y-5 border border-slate-100">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-2">Nuevo Registro</h3>
                    
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1">RESPONSABLE</label>
                        <select id="member" class="w-full p-3 border border-slate-200 rounded-xl bg-slate-50 text-sm outline-none" required>
                            <option value="Yo">Yo</option>
                            <option value="Pap√°">Pap√°</option>
                            <option value="Mam√°">Mam√°</option>
                            <option value="Hermano/a">Hermano/a</option>
                            <option value="Ahorro Familiar">Ahorro Familiar</option>
                        </select>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1">MONTO</label>
                        <input type="number" id="amount" step="0.01" placeholder="0.00" class="w-full p-3 border border-slate-200 rounded-xl text-lg font-bold outline-none" required>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" onclick="setType('income')" id="btn-income" class="p-3 rounded-xl border bg-emerald-500 text-white font-bold text-sm shadow-lg shadow-emerald-100">Ingreso</button>
                        <button type="button" onclick="setType('expense')" id="btn-expense" class="p-3 rounded-xl border bg-white text-slate-400 text-sm">Egreso</button>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1">CATEGOR√çA</label>
                        <input type="text" id="category" placeholder="Ej: Supermercado, Regalo" class="w-full p-3 border border-slate-200 rounded-xl text-sm outline-none" required>
                    </div>

                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 ml-1">FECHA</label>
                        <input type="date" id="date" class="w-full p-3 border border-slate-200 rounded-xl text-sm outline-none" required>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition shadow-xl shadow-blue-100">Guardar Movimiento</button>
                </form>

                <div class="bg-white p-6 rounded-3xl shadow-md border border-slate-100 flex flex-col items-center justify-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-4">Distribuci√≥n Visual</p>
                    <div class="w-full h-48">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Tabla -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
                    <div class="p-6 border-b flex justify-between bg-slate-50 items-center">
                        <span class="font-bold text-slate-700">√öltimos Movimientos</span>
                        <span id="record-count" class="text-[10px] bg-blue-600 px-3 py-1 rounded-full font-bold text-white uppercase tracking-tighter">...</span>
                    </div>
                    <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-[10px] font-bold text-slate-400 uppercase sticky top-0">
                                <tr>
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">Persona</th>
                                    <th class="p-4">Concepto</th>
                                    <th class="p-4 text-right">Monto</th>
                                    <th class="p-4"></th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list" class="divide-y divide-slate-100">
                                <!-- Datos din√°micos -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializar fecha de hoy por defecto
        document.getElementById('date').valueAsDate = new Date();
    </script>
</body>
</html>
